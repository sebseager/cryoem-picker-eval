<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Topaz - cryo-docs</title> <link rel="shortcut icon" href="/cryo-docs/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/cryo-docs/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/cryo-docs/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/cryo-docs/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Topaz | cryo-docs</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="Topaz" /> <meta property="og:locale" content="en_US" /> <link rel="canonical" href="/cryo-docs/topaz.html" /> <meta property="og:url" content="/cryo-docs/topaz.html" /> <meta property="og:site_name" content="cryo-docs" /> <script type="application/ld+json"> {"url":"/cryo-docs/topaz.html","headline":"Topaz","@type":"WebPage","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/cryo-docs/" class="site-title lh-tight"> cryo-docs </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/cryo-docs/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/cryo-docs/pickers" class="nav-list-link">Particle Pickers</a><ul class="nav-list "><li class="nav-list-item "><a href="/cryo-docs/aspire-apple.html" class="nav-list-link">ASPIRE APPLEpicker</a></li><li class="nav-list-item "><a href="/cryo-docs/autocryopicker.html" class="nav-list-link">AutoCryoPicker</a></li><li class="nav-list-item "><a href="/cryo-docs/deeppicker.html" class="nav-list-link">DeepPicker</a></li><li class="nav-list-item "><a href="/cryo-docs/relion-log.html" class="nav-list-link">RELION LoG (Laplacian-of-Gaussian) Picker</a></li><li class="nav-list-item "><a href="/cryo-docs/sphire-cryolo.html" class="nav-list-link">SPHIRE-crYOLO</a></li><li class="nav-list-item active"><a href="/cryo-docs/topaz.html" class="nav-list-link active">Topaz</a></li></ul></li><li class="nav-list-item"><a href="/cryo-docs/empiar.html" class="nav-list-link">EMPIAR</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search cryo-docs" aria-label="Search cryo-docs" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/sebseager/cryo-docs" class="site-button" > cryo-docs on GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/cryo-docs/pickers">Particle Pickers</a></li> <li class="breadcrumb-nav-list-item"><span>Topaz</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="topaz"> <a href="#topaz" class="anchor-heading" aria-labelledby="topaz"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Topaz </h1> <h2 id="summary"> <a href="#summary" class="anchor-heading" aria-labelledby="summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary </h2> <p>Topaz is available as a conda package. We used Python 3.6 for this installation.</p> <p>The Topaz paper can be found <a href="https://doi.org/10.1038/s41592-019-0575-8">here</a>. Refer also to the <a href="https://github.com/tbepler/topaz">GitHub repo</a>, the <a href="https://emgweb.nysbc.org/topaz.html">web-based GUI</a> for generating Topaz commands, and the <a href="https://github.com/tbepler/topaz/tree/master/tutorial">tutorials</a> included in the Topaz repo for more information. The following guide is drawn in part from these resources.</p> <h2 id="installation"> <a href="#installation" class="anchor-heading" aria-labelledby="installation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installation </h2> <p>Create and activate a new conda environment (named <code class="language-plaintext highlighter-rouge">topaz</code>) with the required dependencies.</p> <p>```shell script conda create -n topaz python=3.6 conda activate topaz</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
With the `topaz` environment active, install the Topaz package with its dependencies.

```shell script
conda install topaz -c tbepler -c pytorch
</code></pre></div></div> <p>If your machine/computing cluster does not already have a global installation of <code class="language-plaintext highlighter-rouge">cudatoolkit</code> available, it can be installed to the <code class="language-plaintext highlighter-rouge">topaz</code> environment, as follows.</p> <p>```shell script conda install cudatoolkit=9.0 -c pytorch</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Verify that the Topaz installation works by running `topaz --help`. If it does, you should see a help menu. If your shell returns something like `topaz: command not found`, you may need to deactivate and reactivate the environment.

```shell script
conda deactivate topaz
conda activate topaz
</code></pre></div></div> <p>If you see a traceback (error), however, you may also need to install the <code class="language-plaintext highlighter-rouge">future</code> package. Make sure you’re in the <code class="language-plaintext highlighter-rouge">topaz</code> environment before doing so.</p> <p>```shell script conda install future</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
## Usage

The authors of Topaz provide [several detailed tutorials](https://github.com/tbepler/topaz/tree/master/tutorial) in their repository—in particular, in their [quick start guide](https://github.com/tbepler/topaz/blob/master/tutorial/01_quick_start_guide.ipynb) and [more detailed walkthrough](https://github.com/tbepler/topaz/blob/master/tutorial/02_walkthrough.ipynb). The following outlines broader usage examples and practices.

Start by collecting the micrograph files (`*.mrc`) to be picked in a directory (assuming they are not already available in their own directory). If you would like to use an existing public data set, [our guide to the EMPIAR database](/cryo-docs/empiar.html) may be helpful.

```shell script
mkdir -p name_of_data_set/mrc
mv path/to/your_mrc_files/*.mrc name_of_data_set/mrc
</code></pre></div></div> <p>Here we will use the micrographs located in <code class="language-plaintext highlighter-rouge">demo_data/</code> as an example.</p> <h3 id="preprocessing"> <a href="#preprocessing" class="anchor-heading" aria-labelledby="preprocessing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Preprocessing </h3> <p>Create a Topaz output directory with subdirectories for micrograph preprocessing.</p> <p>```shell script mkdir -p demo_data/topaz_out/processed/micrographs</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
We will now process the micrographs with the `preprocess` command (which combines `downsample` and `normalize` operations). This will downscale the micrographs by a specified multiplier, which is intended to help the neural network learn and converge more quickly. It is suggested in the [detailed walkthrough](https://github.com/tbepler/topaz/blob/master/tutorial/02_walkthrough.ipynb) that a downsampling multiplier should be chosen as follows:

&gt; We recommend downsampling your data enough that the diameter of your particle fits within the receptive field of the CNN architecture you are using ... as a rule of thumb, downsampling to about 4-8 Å per pixel generally works well, but this may need to be adjusted for very large or very small particles to fit the classifier

For reference, the training tab of the [Topaz GUI](https://emgweb.nysbc.org/topaz.html) provides the following classifier specifications:

&gt; Your particle must have a diameter (longest dimension) after downsampling of:
&gt; - 70 pixels or less for resnet8
&gt; - 30 pixels or less for conv31
&gt; - 62 pixels or less for conv63
&gt; - 126 pixels or less for conv127

For example, if the original micrograph resolution was 1.2 Å/pix, a downsampling factor of 5 would bring the preprocessed micrograph's resolution to 6 Å/pix. The preprocessing command would be as follows.

```shell script
topaz preprocess -s 6 -o demo_data/topaz_out/processed/micrographs/ demo_data/mrc/*.mrc
</code></pre></div></div> <p>Topaz has two primary picking strategies: using the <a href="#method-1-use-pretrained-general-model-as-is">pretrained general model</a>, or <a href="#method-2-train-a-model-from-scratch">training a new model</a> (optionally initialized with pretrained weights).</p> <h3 id="method-1-use-pretrained-general-model-as-is"> <a href="#method-1-use-pretrained-general-model-as-is" class="anchor-heading" aria-labelledby="method-1-use-pretrained-general-model-as-is"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Method 1: Use pretrained general model as-is </h3> <p>The <code class="language-plaintext highlighter-rouge">extract</code> command takes input and output paths, as well two numerical parameters. The <code class="language-plaintext highlighter-rouge">-r</code> parameter should be set to the radius of the particle you would like to pick. It is recommended that this be kept relatively small (as appropriate for your particle), as Topaz will not pick particles any closer than this to prevent multiple detections per particle. The <code class="language-plaintext highlighter-rouge">-x</code> parameter will upscale the resulting picks to the original micrograph, and should be the same as <code class="language-plaintext highlighter-rouge">-s</code> from <code class="language-plaintext highlighter-rouge">topaz preprocess</code>.</p> <p>```shell script topaz extract -r 14 -x 6 -o demo_data/topaz_out/predicted_particles_all_upsampled.txt demo_data/topaz_out/processed/micrographs/*.mrc</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Method 2: Train a model from scratch

In order to isolate training data, a subset of the micrographs (here, some `train_1.mrc`, `train_2.mrc`, etc. in `demo_data/mrc/`) should be placed into a separate directory (`demo_data/train_mrc/`). These images, along with some known particle coordinates for each (in `demo_data/train_coord/`), will be used to train the model. crYOLO matches an image to its corresponding coordinate file by comparing the filenames (e.g. `demo_data/train_mrc/Falcon_2012_06_12-14_57_34_0.mrc` and `demo_data/train_coord/Falcon_2012_06_12-14_57_34_0.star` would be paired).

```shell script
mkdir demo_data/train_mrc demo_data/train_coord
mv demo_data/mrc/{train_1.mrc,train_2.mrc,train_3.mrc} demo_data/train_mrc/
</code></pre></div></div> <p>To populate <code class="language-plaintext highlighter-rouge">train_coord/</code>, software like EMAN2’s <code class="language-plaintext highlighter-rouge">e2boxer</code> may be used to generate coordinate files for the training micrographs. Topaz also provides an online graphical interface (located <a href="https://emgweb.nysbc.org/topaz.html">here</a>, in the <code class="language-plaintext highlighter-rouge">Pick | Analyze</code> tab) which can be used to generate training coordinates. For the sake of example, the <code class="language-plaintext highlighter-rouge">.star</code> files located in <code class="language-plaintext highlighter-rouge">demo_data/star</code> can be used. Note that Topaz takes training coordinates as a single file of the following format (columns are separated by single <code class="language-plaintext highlighter-rouge">\t</code> tab characters):</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>image_name  x_coord y_coord
Falcon_2012_06_12-14_57_34_0    3822    3477
Falcon_2012_06_12-14_57_34_0    3810	3402
...
</code></pre></div></div> <p>Topaz also supports conversion from other file formats using its <code class="language-plaintext highlighter-rouge">topaz convert</code> utility. We also provide a conversion utility at <code class="language-plaintext highlighter-rouge">tools/coord_converter.py</code> that may be helpful.</p> <p>Before training can proceed, the training coordinate files must be downscaled by the same factor used to downscale the micrographs. Assuming a downscaling factor of 6, and that your training data are available in <code class="language-plaintext highlighter-rouge">demo_data/train_mrc/</code> and <code class="language-plaintext highlighter-rouge">demo_data/train_coord/</code>:</p> <p>```shell script topaz convert -s 6 -o demo_data/topaz_out/processed/particles.txt demo_data/train_coord/particles.txt</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
We then make new directories for our new model.

```shell script
mkdir -p demo_data/topaz_out/saved_models
</code></pre></div></div> <p>Topaz training can then be run as follows, where <code class="language-plaintext highlighter-rouge">-n</code> represents the approximate number of particles expected per micrograph.</p> <p>```shell script topaz train -n 400 –num-workers 8 <br /> –train-images demo_data/topaz_out/processed/micrographs/ <br /> –train-targets demo_data/topaz_out/processed/particles.txt <br /> –save-prefix demo_data/topaz_out/saved_models/model <br /> -o demo_data/topaz_out/saved_models/model_training.txt</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
See `topaz train --help` for more detailed explanations of the arguments.

This trained model can now be used to extract particles. In the following command, the `-r` parameter should be set to the radius of the particle you would like to pick. It is recommended that this be kept relatively small (as appropriate for your particle), as Topaz will not pick particles any closer than this to prevent multiple detections per particle. The `-x` parameter will upscale the resulting picks to the original micrograph, and should be the same as `-s` from `topaz preprocess`. The `-m` parameter should point to the last epoch of the model trained above.

```shell script
topaz extract -r 14 -x 6 -m demo_data/topaz_out/saved_models/model_epoch10.sav \
              -o demo_data/topaz_out/predicted_particles_all_upsampled.txt \
              demo_data/topaz_out/processed/micrographs/*.mrc
</code></pre></div></div> <h3 id="detection-format-conversion"> <a href="#detection-format-conversion" class="anchor-heading" aria-labelledby="detection-format-conversion"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Detection format conversion </h3> <p>Topaz provides a utility to convert the format of the <code class="language-plaintext highlighter-rouge">extract</code> output file, which can be used like so if needed (e.g. to convert from <code class="language-plaintext highlighter-rouge">.txt</code> to <code class="language-plaintext highlighter-rouge">.star</code>):</p> <p><code class="language-plaintext highlighter-rouge">shell script topaz convert -o demo_data/topaz_out/predicted_particles_all_upsampled.star demo_data/topaz_out/predicted_particles_all_upsampled.txt </code></p> <p>We also provide a script at <code class="language-plaintext highlighter-rouge">tools/coord_converter.py</code> that may be useful for coordinate file conversion.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
